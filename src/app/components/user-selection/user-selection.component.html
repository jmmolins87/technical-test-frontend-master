<div class="min-h-screen bg-[#0f171e] py-16">
	<div class="max-w-5xl mx-auto px-4 text-center">
		<h1 class="text-white text-3xl md:text-4xl font-extrabold tracking-tight mb-10">¿Quién está viendo?</h1>

		<div *ngIf="error" class="text-red-400 text-sm mb-4">{{ error }}</div>

		<div class="flex flex-wrap items-start justify-center gap-8">
			<!-- Tiles: Perfiles existentes -->
			<ng-container *ngIf="users$ | async as users; else empty">
				<button *ngFor="let u of users; trackBy: trackById" (click)="selectUser(u)"
					class="w-28 md:w-32 group focus:outline-none">
					<div
						class="relative w-28 h-28 md:w-32 md:h-32 rounded-full overflow-hidden ring-0 group-hover:ring-4 ring-sky-400 transition">
						<img [src]="u.avatar || defaultImg" [alt]="u.name"
							class="w-full h-full object-cover select-none" />
						<div *ngIf="u.isMinor"
							class="absolute bottom-0 left-0 right-0 text-[10px] py-0.5 bg-emerald-600/80 backdrop-blur-sm text-white text-center">
							KIDS
						</div>
					</div>
					<div class="mt-3">
						<div class="font-medium truncate text-white" title="{{u.name}}">{{ u.name }}</div>
						<div class="text-xs text-gray-400">{{ u.completedIds.length }} completados</div>
					</div>
					<div *ngIf="editMode" class="mt-2 flex justify-center gap-2 text-xs">
						<a [routerLink]="['/profile', u.id, 'edit']" (click)="$event.stopPropagation()"
							class="px-2 py-1 rounded border border-sky-500 text-sky-400 hover:bg-sky-500/10">Editar</a>
						<button type="button" (click)="onDeleteUser(u, $event)"
							class="px-2 py-1 rounded border border-red-500 text-red-400 hover:bg-red-500/10">Borrar</button>
					</div>
				</button>

				<!-- Tile: Añadir nuevo (al final) -->
				<button (click)="addRandomUser()" class="w-28 md:w-32 group focus:outline-none" [disabled]="loading">
					<div
						class="w-28 h-28 md:w-32 md:h-32 rounded-full border-2 border-dashed border-gray-500/60 flex items-center justify-center bg-transparent shadow-none group-hover:border-sky-400 transition">
						<span *ngIf="!loading" aria-hidden="true"
							class="text-4xl text-gray-400 group-hover:text-sky-400">＋</span>
						<span *ngIf="loading" class="inline-flex items-center justify-center" aria-live="polite"
							aria-label="Creando">
							<span
								class="block w-6 h-6 rounded-full border-2 border-gray-400 border-t-transparent animate-spin"></span>
						</span>
					</div>
					<div class="mt-3 text-sm font-medium text-gray-300 group-hover:text-white">Añadir perfil</div>
				</button>
			</ng-container>
			<ng-template #empty>
				<div class="w-full text-center text-gray-400">No hay perfiles aún. Crea uno nuevo con el botón “Añadir
					perfil”.</div>
			</ng-template>
		</div>

		<!-- Botón inferior para editar perfiles -->
		<ng-container *ngIf="users$ | async as users">
			<div class="mt-10 flex justify-center" *ngIf="users.length > 0">
				<button (click)="toggleEditMode()"
						class="px-5 py-2 rounded-full border border-sky-500 text-sky-400 hover:bg-sky-500/10 transition">
					{{ editMode ? 'Terminar edición' : 'Editar perfiles' }}
				</button>
			</div>
		</ng-container>
	</div>
</div>

<app-confirm-modal
	[open]="modalOpen"
	[title]="'¿Eliminar este perfil?'"
	[message]="'Esta acción no se puede deshacer. ¿Seguro que quieres borrar el perfil ' + (modalUser?.name ?? '') + '?'"
	[confirmText]="'Eliminar'"
	[cancelText]="'Cancelar'"
	(confirm)="confirmModal()"
	(cancel)="closeModal()"
></app-confirm-modal>